<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Secure Challenge - Test</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px; 
      margin: 40px auto; 
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    h2 { color: #555; font-size: 18px; margin-top: 0; }
    .info { background: #e3f2fd; padding: 16px; border-radius: 4px; margin: 16px 0; }
    .warning { background: #fff3e0; padding: 16px; border-radius: 4px; margin: 16px 0; }
    .success { background: #e8f5e9; padding: 16px; border-radius: 4px; margin: 16px 0; }
    pre { 
      background: #263238; 
      color: #aed581; 
      padding: 16px; 
      border-radius: 4px; 
      overflow-x: auto;
      font-size: 13px;
    }
    code { font-family: 'Monaco', 'Menlo', monospace; }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 8px 8px 8px 0;
    }
    button:hover { background: #1565c0; }
    button.secondary { background: #757575; }
    button.secondary:hover { background: #616161; }
    #challengeFrame {
      width: 100%;
      height: 500px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .step { 
      display: flex; 
      align-items: flex-start; 
      margin: 16px 0;
      padding: 16px;
      background: #fafafa;
      border-radius: 4px;
    }
    .step-number {
      background: #1976d2;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 16px;
      flex-shrink: 0;
    }
    .hidden { display: none; }
    #cresOutput {
      width: 100%;
      min-height: 100px;
      font-family: monospace;
      font-size: 12px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 8px;
    }
    .label { font-weight: 600; color: #333; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Test 3D Secure Challenge</h1>
    <p>Este archivo te permite completar el challenge 3DS manualmente y obtener el CRes.</p>
  </div>

  <div class="card">
    <h2>Instrucciones</h2>
    
    <div class="step">
      <div class="step-number">1</div>
      <div>
        <p class="label">Iniciar el Challenge</p>
        <p>Haz clic en el boton para cargar el iframe del ACS. Ingresa el codigo OTP de prueba: <strong>1234</strong></p>
        <button onclick="startChallenge()">Iniciar Challenge</button>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">2</div>
      <div>
        <p class="label">Completa la autenticacion</p>
        <p>El ACS mostrara un formulario. Usa el codigo <strong>1234</strong> para aprobar.</p>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">3</div>
      <div>
        <p class="label">Copia el CRes</p>
        <p>Cuando el challenge termine, el CRes aparecera abajo. Copialo y pegalo en la terminal.</p>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Challenge Frame</h2>
    <div class="info">
      <strong>TermUrl:</strong> https://app.gruard.com/api/azul/3ds/callback?sid=1769264746086<br>
      <small>El ACS redirigira aqui con el CRes cuando completes el challenge.</small>
    </div>
    
    <div id="frameContainer" class="hidden">
      <iframe id="challengeFrame" name="challengeFrame"></iframe>
    </div>
    
    <form id="challengeForm" method="POST" action="https://3ds-acs.test.modirum.com/mdpayacs/creq;token=365953021.1769264745.jhco5oQeVwMnwNDduk8GPEgcAV6eDq2LAnSEgguda88" target="challengeFrame" class="hidden">
      <input type="hidden" name="creq" value="ewogICAgImFjc1RyYW5zSUQiOiAiNzQyNmM5ZmUtYmI5Zi00MjVhLTliNDctNDY1MDljNjM3N2JkIiwKICAgICJjaGFsbGVuZ2VXaW5kb3dTaXplIjogIjAzIiwKICAgICJtZXNzYWdlVHlwZSI6ICJDUmVxIiwKICAgICJtZXNzYWdlVmVyc2lvbiI6ICIyLjIuMCIsCiAgICAidGhyZWVEU1NlcnZlclRyYW5zSUQiOiAiNzYxYWViNmUtYjI5NC01ZDQyLTgwMDAtMDAwMDA0MDRlNjUzIgp9">
    </form>
  </div>

  <div class="card">
    <h2>CRes Capturado</h2>
    <div class="warning">
      <p><strong>Nota:</strong> El CRes se capturara cuando el ACS redirija al TermUrl.</p>
      <p>Si usas una URL local que no existe, abre DevTools (F12) > Network y busca la peticion al TermUrl para ver el CRes en los parametros.</p>
    </div>
    <textarea id="cresOutput" placeholder="El CRes aparecera aqui o pegalo manualmente..."></textarea>
    <br>
    <button onclick="copyCRes()">Copiar CRes</button>
    <button class="secondary" onclick="extractFromUrl()">Extraer de URL</button>
  </div>

  <div class="card">
    <h2>Datos Tecnicos</h2>
    <details>
      <summary>Ver RedirectPostUrl</summary>
      <pre>https://3ds-acs.test.modirum.com/mdpayacs/creq;token=365953021.1769264745.jhco5oQeVwMnwNDduk8GPEgcAV6eDq2LAnSEgguda88</pre>
    </details>
    <details>
      <summary>Ver CReq (Base64)</summary>
      <pre>ewogICAgImFjc1RyYW5zSUQiOiAiNzQyNmM5ZmUtYmI5Zi00MjVhLTliNDctNDY1MDljNjM3N2JkIiwKICAgICJjaGFsbGVuZ2VXaW5kb3dTaXplIjogIjAzIiwKICAgICJtZXNzYWdlVHlwZSI6ICJDUmVxIiwKICAgICJtZXNzYWdlVmVyc2lvbiI6ICIyLjIuMCIsCiAgICAidGhyZWVEU1NlcnZlclRyYW5zSUQiOiAiNzYxYWViNmUtYjI5NC01ZDQyLTgwMDAtMDAwMDA0MDRlNjUzIgp9</pre>
    </details>
    <details>
      <summary>Ver CReq (Decodificado)</summary>
      <pre id="creqDecoded"></pre>
    </details>
  </div>

  <script>
    // Decodificar CReq
    try {
      const decoded = atob('ewogICAgImFjc1RyYW5zSUQiOiAiNzQyNmM5ZmUtYmI5Zi00MjVhLTliNDctNDY1MDljNjM3N2JkIiwKICAgICJjaGFsbGVuZ2VXaW5kb3dTaXplIjogIjAzIiwKICAgICJtZXNzYWdlVHlwZSI6ICJDUmVxIiwKICAgICJtZXNzYWdlVmVyc2lvbiI6ICIyLjIuMCIsCiAgICAidGhyZWVEU1NlcnZlclRyYW5zSUQiOiAiNzYxYWViNmUtYjI5NC01ZDQyLTgwMDAtMDAwMDA0MDRlNjUzIgp9');
      document.getElementById('creqDecoded').textContent = decoded;
    } catch(e) {
      document.getElementById('creqDecoded').textContent = 'Error al decodificar';
    }

    function startChallenge() {
      document.getElementById('frameContainer').classList.remove('hidden');
      document.getElementById('challengeForm').submit();
    }

    function copyCRes() {
      const textarea = document.getElementById('cresOutput');
      textarea.select();
      document.execCommand('copy');
      alert('CRes copiado al portapapeles');
    }

    function extractFromUrl() {
      const url = prompt('Pega la URL completa del TermUrl con los parametros:');
      if (url) {
        try {
          const urlObj = new URL(url);
          const cres = urlObj.searchParams.get('cres') || urlObj.searchParams.get('CRes');
          if (cres) {
            document.getElementById('cresOutput').value = cres;
            alert('CRes extraido correctamente');
          } else {
            // Intentar buscar en el body si es una URL con fragmento
            const match = url.match(/[?&]c[rR]es=([^&]+)/);
            if (match) {
              document.getElementById('cresOutput').value = decodeURIComponent(match[1]);
              alert('CRes extraido correctamente');
            } else {
              alert('No se encontro CRes en la URL');
            }
          }
        } catch(e) {
          alert('URL invalida: ' + e.message);
        }
      }
    }

    
    // Auto-extraer CRes si la URL del iframe cambia (si es posible por Same-Origin, si no, manual)
    setInterval(() => {
      try {
        const frame = document.getElementById('challengeFrame');
        if (frame && frame.contentWindow) {
          const frameUrl = frame.contentWindow.location.href;
          const urlObj = new URL(frameUrl);
          const cres = urlObj.searchParams.get('cres') || urlObj.searchParams.get('CRes');
          if (cres) {
            document.getElementById('cresOutput').value = cres;
          }
        }
      } catch (e) {
        // Ignorar errores de cross-origin
      }
    }, 1000);

    // Escuchar mensajes del iframe (por si el ACS usa postMessage)
    window.addEventListener('message', function(event) {
      console.log('Mensaje recibido:', event.data);
      if (event.data && (event.data.cres || event.data.CRes)) {
        document.getElementById('cresOutput').value = event.data.cres || event.data.CRes;
      }
    });
  </script>
</body>
</html>
name: Build iOS

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-simulator:
    name: Build for Simulator
    runs-on: macos-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Select Xcode version
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -z "$XCODE_PATH" ]; then
            XCODE_PATH="/Applications/Xcode.app"
          fi
          echo "Using Xcode at: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web assets
        env:
          VITE_MAPBOX_ACCESS_TOKEN: ${{ secrets.VITE_MAPBOX_ACCESS_TOKEN }}
        run: npm run build
      
      - name: Patch Capacitor CLI template.js
        run: |
          cat > node_modules/@capacitor/cli/dist/util/template.js << 'EOF'
          "use strict";
          Object.defineProperty(exports, "__esModule", { value: true });
          exports.extractTemplate = void 0;
          const fs_extra_1 = require("fs-extra");
          const tar = require("tar");
          const path_1 = require("path");
          
          async function extractTemplate(src, dir) {
              if (!src) {
                  const cliDir = path_1.resolve(__dirname, '..');
                  const assetsDir = path_1.join(cliDir, 'assets');
                  
                  if (dir.includes('capacitor-cordova-android-plugins')) {
                      src = path_1.join(assetsDir, 'capacitor-cordova-android-plugins.tar.gz');
                  } else if (dir.includes('capacitor-cordova-ios-plugins')) {
                      src = path_1.join(assetsDir, 'capacitor-cordova-ios-plugins.tar.gz');
                  } else if (dir.includes('android')) {
                      src = path_1.join(assetsDir, 'android-template.tar.gz');
                  } else if (dir.includes('ios')) {
                      src = path_1.join(assetsDir, 'ios-pods-template.tar.gz');
                  }
                  
                  if (!src) {
                      throw new Error('Template source is undefined and could not be inferred for directory: ' + dir);
                  }
              }
              
              await (0, fs_extra_1.mkdirp)(dir);
              await tar.extract({ file: src, cwd: dir });
          }
          exports.extractTemplate = extractTemplate;
          EOF
      
      - name: Sync Capacitor
        run: npx cap sync ios
      
      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install
      
      - name: Build for Simulator
        run: |
          cd ios/App
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            CODE_SIGNING_ALLOWED=NO \
            build

  build-release:
    name: Build Release IPA
    runs-on: macos-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.IOS_CERTIFICATE_BASE64 }}" ]; then
            echo "::warning::iOS release build skipped - IOS_CERTIFICATE_BASE64 secret not configured"
            echo "To enable iOS release builds, configure the following secrets:"
            echo "  - IOS_CERTIFICATE_BASE64: Base64 encoded .p12 certificate"
            echo "  - IOS_CERTIFICATE_PASSWORD: Password for the .p12 certificate"
            echo "  - IOS_PROVISIONING_PROFILE_BASE64: Base64 encoded provisioning profile"
            echo "  - IOS_TEAM_ID: Your Apple Developer Team ID"
            exit 0
          fi
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Select Xcode version
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version
      
      - name: Install Apple Certificate
        if: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
        env:
          CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
      
      - name: Install Provisioning Profile
        if: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 != '' }}
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web assets
        env:
          VITE_MAPBOX_ACCESS_TOKEN: ${{ secrets.VITE_MAPBOX_ACCESS_TOKEN }}
        run: npm run build
      
      - name: Patch Capacitor CLI template.js
        run: |
          cat > node_modules/@capacitor/cli/dist/util/template.js << 'EOF'
          "use strict";
          Object.defineProperty(exports, "__esModule", { value: true });
          exports.extractTemplate = void 0;
          const fs_extra_1 = require("fs-extra");
          const tar = require("tar");
          const path_1 = require("path");
          
          async function extractTemplate(src, dir) {
              if (!src) {
                  const cliDir = path_1.resolve(__dirname, '..');
                  const assetsDir = path_1.join(cliDir, 'assets');
                  
                  if (dir.includes('capacitor-cordova-android-plugins')) {
                      src = path_1.join(assetsDir, 'capacitor-cordova-android-plugins.tar.gz');
                  } else if (dir.includes('capacitor-cordova-ios-plugins')) {
                      src = path_1.join(assetsDir, 'capacitor-cordova-ios-plugins.tar.gz');
                  } else if (dir.includes('android')) {
                      src = path_1.join(assetsDir, 'android-template.tar.gz');
                  } else if (dir.includes('ios')) {
                      src = path_1.join(assetsDir, 'ios-pods-template.tar.gz');
                  }
                  
                  if (!src) {
                      throw new Error('Template source is undefined and could not be inferred for directory: ' + dir);
                  }
              }
              
              await (0, fs_extra_1.mkdirp)(dir);
              await tar.extract({ file: src, cwd: dir });
          }
          exports.extractTemplate = extractTemplate;
          EOF
      
      - name: Sync Capacitor
        run: npx cap sync ios
      
      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install
      
      - name: Build Release Archive
        if: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          cd ios/App
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath $RUNNER_TEMP/GruaRD.xcarchive \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            clean archive
      
      - name: Export IPA
        if: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
        run: |
          cat > $RUNNER_TEMP/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          xcodebuild \
            -exportArchive \
            -archivePath $RUNNER_TEMP/GruaRD.xcarchive \
            -exportPath $RUNNER_TEMP/ipa \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist
      
      - name: Upload IPA
        if: ${{ secrets.IOS_CERTIFICATE_BASE64 != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-ipa
          path: ${{ runner.temp }}/ipa/*.ipa
      
      - name: Cleanup
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
          rm -f $RUNNER_TEMP/certificate.p12 $RUNNER_TEMP/profile.mobileprovision
